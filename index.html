import React, { useState, useEffect, useRef } from 'react';
import { Search, BookOpen, Feather, MessageCircle, Share2, Star, CheckCircle, XCircle, Brain, RefreshCw, Sparkles, ExternalLink, History, ArrowRight, Calendar, Trophy, Download, FileSpreadsheet, Flame, Volume2, Layers, X, ChevronRight, ChevronLeft, Target, Medal, Crown, Zap, Map, Lightbulb, HelpCircle, User, Home, Book, Play, Gift, Quote, TrendingUp, Clock, Timer } from 'lucide-react';

/**
 * SAT TH·ª¶ KHOA DESIGN SYSTEM & LOGIC - FINAL VERSION (Fixed Speed Review)
 * * Colors:
 * - Royal Blue: #004488 (Brand Primary)
 * - Gold: #FFD700 (Brand Accent)
 * - Background: slate-50
 * * Fonts:
 * - Primary: Crimson Pro
 */

const DAILY_WORDS = [
  "Serendipity", "Ephemeral", "Ubiquitous", "Pragmatic", "Magnanimous", 
  "Esoteric", "Cacophony", "Ennui", "Languid", "Fastidious", "Alacrity", "Benevolent",
  "Gregarious", "Iconoclast", "Docile", "Disparate", "Chicanery"
];

const QUOTES = [
  { text: "The roots of education are bitter, but the fruit is sweet.", author: "Aristotle" },
  { text: "Education is the passport to the future.", author: "Malcolm X" },
  { text: "Thi√™n t√†i ch·ªâ l√† 1% c·∫£m h·ª©ng, 99% l√† m·ªì h√¥i.", author: "Thomas Edison" },
  { text: "S·ª± h·ªçc nh∆∞ con thuy·ªÅn ƒëi tr√™n d√≤ng n∆∞·ªõc ng∆∞·ª£c, kh√¥ng ti·∫øn ·∫Øt ph·∫£i l√πi.", author: "C·ªï nh√¢n" },
  { text: "Don't let what you cannot do interfere with what you can do.", author: "John Wooden" }
];

// Mock Data for Leaderboard
const MOCK_LEADERBOARD = [
  { name: "Nguy·ªÖn VƒÉn A", xp: 15000, id: "u1" },
  { name: "Tr·∫ßn Th·ªã B", xp: 12500, id: "u2" },
  { name: "L√™ Ho√†ng C", xp: 9800, id: "u3" },
  { name: "Ph·∫°m Minh D", xp: 5200, id: "u4" },
];

const DAILY_GOAL = 5; 

// --- GAMIFICATION CONFIG ---
const RANKS = [
  { level: 1, title: "H·ªçc Vi√™n M·ªõi", minXP: 0 },
  { level: 5, title: "Sƒ© T·ª≠ ChƒÉm Ch·ªâ", minXP: 500 },
  { level: 10, title: "Chi·∫øn Binh SAT", minXP: 1500 },
  { level: 20, title: "Cao Th·ªß T·ª´ V·ª±ng", minXP: 4000 },
  { level: 50, title: "SAT Th·ªß Khoa", minXP: 10000 }
];

const XP_REWARDS = {
  SEARCH: 15,
  QUIZ_EASY: 10,
  QUIZ_MEDIUM: 20,
  QUIZ_HARD: 30,
  DAILY_GOAL_MET: 100,
  FLASHCARD_REVIEW: 5,
  DAILY_LOGIN: 50,
  SPEED_REVIEW_CORRECT: 20
};

const SATVocabularyTool = () => {
  // --- STATE MANAGEMENT ---
  // Core Data
  const [inputWord, setInputWord] = useState('');
  const [loading, setLoading] = useState(false);
  const [result, setResult] = useState(null);
  const [history, setHistory] = useState([]);
  
  // Quiz State
  const [quizMode, setQuizMode] = useState(false);
  const [currentQuizIndex, setCurrentQuizIndex] = useState(0);
  const [quizStatus, setQuizStatus] = useState({}); 
  
  // Navigation & View
  const [activeTab, setActiveTab] = useState('study'); 
  
  // User Progress
  const [streak, setStreak] = useState(0);
  const [wordsToday, setWordsToday] = useState(0);
  const [dailyWord, setDailyWord] = useState('');
  const [dailyQuote, setDailyQuote] = useState(QUOTES[0]);
  const [weeklyActivity, setWeeklyActivity] = useState([false, false, false, false, false, false, false]); 
  
  // Gamification
  const [xp, setXP] = useState(0);
  const [level, setLevel] = useState(1);
  const [notification, setNotification] = useState(null); 
  const [showLevelUp, setShowLevelUp] = useState(false);
  const [showDailyBonus, setShowDailyBonus] = useState(false); 
  const [showBadgeDetails, setShowBadgeDetails] = useState(null); 

  // Flashcards
  const [showFlashcards, setShowFlashcards] = useState(false);
  const [currentCardIndex, setCurrentCardIndex] = useState(0);
  const [isFlipped, setIsFlipped] = useState(false);

  // Speed Review State
  const [speedReviewMode, setSpeedReviewMode] = useState(false);
  const [speedReviewData, setSpeedReviewData] = useState({ questions: [], currentIndex: 0, score: 0, timeLeft: 30, isActive: false, isFinished: false });

  // Smart Review
  const [reviewSuggestion, setReviewSuggestion] = useState(null);

  // Refs & API
  const resultRef = useRef(null);
  const topRef = useRef(null); 
  const apiKey = ""; 

  // --- INITIALIZATION ---
  useEffect(() => {
    // 1. Load History & Stats
    const savedHistory = localStorage.getItem('sat_vocab_history_v2');
    let loadedHistory = [];
    if (savedHistory) {
      loadedHistory = JSON.parse(savedHistory);
      setHistory(loadedHistory);
      
      if (loadedHistory.length > 0) {
        const randomWord = loadedHistory[Math.floor(Math.random() * loadedHistory.length)];
        setReviewSuggestion(randomWord);
      }
    }

    const savedXP = parseInt(localStorage.getItem('user_xp') || '0');
    setXP(savedXP);
    calculateLevel(savedXP);

    // Load Weekly Activity
    const savedWeekly = localStorage.getItem('weekly_activity');
    if (savedWeekly) setWeeklyActivity(JSON.parse(savedWeekly));

    // 2. Streak & Daily Tracking Logic
    const lastVisit = localStorage.getItem('last_visit_date');
    const currentStreak = parseInt(localStorage.getItem('study_streak') || '0');
    const savedWordsToday = parseInt(localStorage.getItem('words_learned_today') || '0');
    const today = new Date().toDateString();
    const todayDayIndex = new Date().getDay() === 0 ? 6 : new Date().getDay() - 1; 

    if (lastVisit !== today) {
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      
      if (lastVisit === yesterday.toDateString()) {
        const newStreak = currentStreak + 1;
        setStreak(newStreak);
        localStorage.setItem('study_streak', newStreak.toString());
      } else {
        setStreak(1);
        localStorage.setItem('study_streak', '1');
      }
      
      setWordsToday(0);
      localStorage.setItem('words_learned_today', '0');
      localStorage.setItem('last_visit_date', today);

      setShowDailyBonus(true);

      setWeeklyActivity(prev => {
        const newWeek = [...prev];
        if (todayDayIndex >= 0 && todayDayIndex < 7) {
            newWeek[todayDayIndex] = true;
        } 
        localStorage.setItem('weekly_activity', JSON.stringify(newWeek));
        return newWeek;
      });

    } else {
      setStreak(currentStreak);
      setWordsToday(savedWordsToday);
    }

    const dayIndex = new Date().getDate() % DAILY_WORDS.length;
    setDailyWord(DAILY_WORDS[dayIndex]);
    setDailyQuote(QUOTES[dayIndex % QUOTES.length]);

  }, []);

  // --- TIMER LOGIC FOR SPEED REVIEW ---
  useEffect(() => {
    let timer;
    if (speedReviewMode && speedReviewData.isActive && speedReviewData.timeLeft > 0) {
      timer = setInterval(() => {
        setSpeedReviewData(prev => ({ ...prev, timeLeft: prev.timeLeft - 1 }));
      }, 1000);
    } else if (speedReviewData.timeLeft === 0 && speedReviewData.isActive) {
      setSpeedReviewData(prev => ({ ...prev, isActive: false, isFinished: true }));
    }
    return () => clearInterval(timer);
  }, [speedReviewMode, speedReviewData.isActive, speedReviewData.timeLeft]);

  // --- HELPER FUNCTIONS ---
  const addXP = (amount) => {
    const newXP = xp + amount;
    setXP(newXP);
    localStorage.setItem('user_xp', newXP.toString());
    calculateLevel(newXP);
    showNotification(`+${amount} XP`, 'success');
  };

  const claimDailyBonus = () => {
    addXP(XP_REWARDS.DAILY_LOGIN);
    setShowDailyBonus(false);
  };

  const calculateLevel = (currentXP) => {
    const newLevel = Math.floor(Math.sqrt(currentXP / 50)) + 1;
    if (newLevel > level) {
      setLevel(newLevel);
      setShowLevelUp(true); 
    } else {
      setLevel(newLevel); 
    }
  };

  const getCurrentRank = () => {
    return [...RANKS].reverse().find(r => level >= r.level) || RANKS[0];
  };

  const getLeaderboard = () => {
    const currentUser = { name: "B·∫°n", xp: xp, id: "me", isUser: true };
    const allUsers = [...MOCK_LEADERBOARD, currentUser].sort((a, b) => b.xp - a.xp);
    return allUsers.slice(0, 5); 
  };

  const showNotification = (msg, type = 'success') => {
    setNotification({ message: msg, type });
    setTimeout(() => setNotification(null), 3000);
  };

  const updateWordsToday = () => {
    const newCount = wordsToday + 1;
    setWordsToday(newCount);
    localStorage.setItem('words_learned_today', newCount.toString());
    
    if (newCount === DAILY_GOAL) {
      addXP(XP_REWARDS.DAILY_GOAL_MET);
      showNotification(`üéâ Ho√†n th√†nh m·ª•c ti√™u ng√†y! +${XP_REWARDS.DAILY_GOAL_MET} XP`, 'success');
    }
  };

  const addToHistory = (data) => {
    const exists = history.some(item => item.word.toLowerCase() === data.word.toLowerCase());
    if (!exists) {
      const newHistory = [data, ...history].slice(0, 50);
      setHistory(newHistory);
      localStorage.setItem('sat_vocab_history_v2', JSON.stringify(newHistory));
      updateWordsToday();
      addXP(XP_REWARDS.SEARCH);
    }
  };

  const playAudio = (text) => {
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'en-US';
    window.speechSynthesis.speak(utterance);
  };

  const exportToExcel = () => {
    if (history.length === 0) {
      showNotification("B·∫°n ch∆∞a c√≥ t·ª´ v·ª±ng n√†o trong l·ªãch s·ª≠ ƒë·ªÉ xu·∫•t!", "info");
      return;
    }
    const headers = ["Th·ª© T·ª±", "T·ª´", "Ph√°t √¢m", "Nghƒ©a", "G·ªëc t·ª´", "V√≠ d·ª•"];
    const rows = history.map((item, index) => {
      const clean = (text) => {
        if (!text) return '""';
        const str = String(text).replace(/[\r\n]+/g, " ").replace(/"/g, '""'); 
        return `"${str}"`;
      };
      const exampleSentence = item.examples && item.examples.length > 0 ? item.examples[0].text : "";
      return [
        index + 1,
        clean(item.word),
        clean(item.phonetic),
        clean(item.vietnamese),
        clean(item.origin || "ƒêang c·∫≠p nh·∫≠t"),
        clean(exampleSentence)
      ].join(";");
    });
    const csvContent = "\uFEFFsep=;\n" + headers.join(";") + "\n" + rows.join("\n");
    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.setAttribute("href", url);
    link.setAttribute("download", `SAT_Vocabulary_${new Date().toLocaleDateString('vi-VN').replace(/\//g, '-')}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  // --- SPEED REVIEW LOGIC (FIXED) ---
  const startSpeedReview = () => {
    // 1. Filter valid items (Must have word and vietnamese meaning)
    const validHistory = history.filter(item => item.word && item.vietnamese);

    // 2. Check length with valid items
    if (validHistory.length < 4) {
      showNotification("C·∫ßn √≠t nh·∫•t 4 t·ª´ v·ª±ng ƒë·∫ßy ƒë·ªß ƒë·ªÉ m·ªü kh√≥a ch·∫ø ƒë·ªô n√†y!", "info");
      return;
    }
    
    // Generate 5 random questions
    const questions = [];
    const usedIndices = new Set();
    
    for(let i=0; i<5; i++) {
        if (validHistory.length <= i) break;
        let correctIdx;
        let attempts = 0;
        do { 
            correctIdx = Math.floor(Math.random() * validHistory.length); 
            attempts++;
        } while(usedIndices.has(correctIdx) && attempts < 20);
        
        usedIndices.add(correctIdx);
        
        const correctWord = validHistory[correctIdx];
        
        const options = [correctWord.vietnamese];
        let optionAttempts = 0;
        while (options.length < 4 && optionAttempts < 50) {
            const randomWrong = validHistory[Math.floor(Math.random() * validHistory.length)].vietnamese;
            if (!options.includes(randomWrong)) options.push(randomWrong);
            optionAttempts++;
        }
        
        while(options.length < 4) {
            options.push(`Nghƒ©a kh√°c ${options.length}`);
        }
        
        questions.push({
            word: correctWord.word,
            correct: correctWord.vietnamese,
            options: options.sort(() => Math.random() - 0.5)
        });
    }

    setSpeedReviewData({
        questions,
        currentIndex: 0,
        score: 0,
        timeLeft: 30,
        isActive: true,
        isFinished: false
    });
    setSpeedReviewMode(true);
  };

  const handleSpeedAnswer = (selected) => {
    const currentQ = speedReviewData.questions[speedReviewData.currentIndex];
    const isCorrect = selected === currentQ.correct;
    
    if (isCorrect) {
        setSpeedReviewData(prev => ({
            ...prev,
            score: prev.score + 1,
            currentIndex: prev.currentIndex + 1,
            isFinished: prev.currentIndex + 1 >= prev.questions.length,
            isActive: !(prev.currentIndex + 1 >= prev.questions.length)
        }));
    } else {
        setSpeedReviewData(prev => ({
            ...prev,
            currentIndex: prev.currentIndex + 1,
            isFinished: prev.currentIndex + 1 >= prev.questions.length,
            isActive: !(prev.currentIndex + 1 >= prev.questions.length)
        }));
    }
  };

  // --- GEMINI AI INTEGRATION ---
  const generateAIContent = async (word) => {
    const systemPrompt = `
      B·∫°n l√† chuy√™n gia luy·ªán thi SAT (SAT Th·ªß Khoa). T·ª´ c·∫ßn gi·∫£i th√≠ch: "${word}".
      
      Y√äU C·∫¶U: Tr·∫£ v·ªÅ JSON thu·∫ßn (kh√¥ng markdown).
      1. "origin": Etymology gi·ªëng Oxford Dictionary.
      2. "suggestions": 3 t·ª´ SAT n√¢ng cao li√™n quan. QUAN TR·ªåNG: CH·ªà TR·∫¢ V·ªÄ T·ª™ TI·∫æNG ANH (V√≠ d·ª•: "Serendipity"), KH√îNG K√àM NGHƒ®A.
      3. "quiz.explanation": Gi·∫£i th√≠ch t·∫°i sao ƒë√°p √°n ƒë√∫ng v√† t·∫°i sao c√°c ƒë√°p √°n kh√°c sai.
      4. "quizzes": M·∫£ng 3 c√¢u h·ªèi (D·ªÖ -> Trung B√¨nh -> Kh√≥).
      5. "synonyms": M·∫£ng t·ª´ ƒë·ªìng nghƒ©a.
      6. "antonyms": M·∫£ng t·ª´ tr√°i nghƒ©a.

      JSON Structure:
      {
        "word": "${word}", "phonetic": "/.../", "type": "adj.", "vietnamese": "...", "origin": "...",
        "blurb": "...", "synonyms": ["..."], "antonyms": ["..."],
        "examples": [{"type": "Classic Literature", "source": "...", "text": "..."}],
        "quizzes": [
           { "level": "D·ªÖ", "question": "...", "options": ["A", "B", "C", "D"], "answer": "...", "explanation": "..." },
           { "level": "Trung b√¨nh", "question": "...", "options": ["A", "B", "C", "D"], "answer": "...", "explanation": "..." },
           { "level": "Kh√≥", "question": "...", "options": ["A", "B", "C", "D"], "answer": "...", "explanation": "..." }
        ],
        "suggestions": ["...", "...", "..."]
      }
    `;

    try {
      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ contents: [{ parts: [{ text: systemPrompt }] }] }),
        }
      );
      const data = await response.json();
      if (data.candidates && data.candidates[0].content) {
        let text = data.candidates[0].content.parts[0].text;
        text = text.replace(/```json/g, '').replace(/```/g, '').trim();
        return JSON.parse(text);
      }
    } catch (error) {
      console.error("AI Error:", error);
      return null;
    }
  };

  const handleSearch = async (e, wordOverride = null) => {
    if (e) e.preventDefault();
    
    let searchTerm = wordOverride || inputWord;
    searchTerm = searchTerm.replace(/[\(\[].*?[\)\]]/g, "").trim();

    if (!searchTerm) return;

    if (wordOverride) setInputWord(searchTerm);
    
    setActiveTab('study');
    if(window.innerWidth < 1024) {
       setTimeout(() => topRef.current?.scrollIntoView({ behavior: 'smooth' }), 100);
    }

    setLoading(true);
    setResult(null);
    setQuizMode(false);
    setQuizStatus({});
    setCurrentQuizIndex(0);

    const aiResult = await generateAIContent(searchTerm);
    if (aiResult) {
      if (aiResult.quizzes) {
          aiResult.quizzes = aiResult.quizzes.map(q => ({
              ...q,
              options: q.options.map(opt => opt.trim()),
              answer: q.answer.trim()
          }));
      }
      setResult(aiResult);
      addToHistory(aiResult);
    } else {
      setResult({
        word: searchTerm, phonetic: "Error", type: "N/A", vietnamese: "L·ªói k·∫øt n·ªëi", origin: "...",
        blurb: "H·ªá th·ªëng ƒëang qu√° t·∫£i, vui l√≤ng th·ª≠ l·∫°i sau.", synonyms: [], antonyms: [], examples: [], quizzes: [], suggestions: []
      });
    }
    setLoading(false);
  };

  const handleQuizAnswer = (option) => {
    if (quizStatus[currentQuizIndex] === 'correct') return;

    const currentQuiz = result.quizzes[currentQuizIndex];
    const selected = option.trim().toLowerCase();
    const correct = currentQuiz.answer.trim().toLowerCase();

    if (selected === correct) {
      setQuizStatus(prev => ({ ...prev, [currentQuizIndex]: 'correct' }));
      let reward = XP_REWARDS.QUIZ_EASY;
      if (currentQuizIndex === 1) reward = XP_REWARDS.QUIZ_MEDIUM;
      if (currentQuizIndex === 2) reward = XP_REWARDS.QUIZ_HARD;
      addXP(reward);
    } else {
      setQuizStatus(prev => ({ ...prev, [currentQuizIndex]: 'incorrect' }));
      showNotification("Ch∆∞a ch√≠nh x√°c, h√£y ƒë·ªçc gi·∫£i th√≠ch nh√©!", "info");
    }
  };

  // --- SUB-COMPONENTS ---
  const currentRank = getCurrentRank();
  const xpForCurrentLevel = (level - 1) * (level - 1) * 50; 
  const xpForNextLevel = level * level * 50;
  const xpProgress = Math.min(((xp - xpForCurrentLevel) / (xpForNextLevel - xpForCurrentLevel)) * 100, 100);

  const renderProfileSection = () => (
    <>
      <div className="bg-white p-6 rounded-2xl shadow-lg border border-slate-100 relative overflow-hidden mb-6">
          <div className="absolute top-0 right-0 w-24 h-24 bg-amber-100 rounded-bl-full opacity-50"></div>
          <div className="relative z-10">
            <div className="flex items-center mb-4">
              <div className="w-14 h-14 bg-blue-100 rounded-full flex items-center justify-center mr-4 border-2 border-[#004488]">
                  <span className="text-2xl font-bold text-[#004488]">{level}</span>
              </div>
              <div>
                  <p className="text-xs text-slate-500 font-bold uppercase tracking-wider">C·∫•p ƒê·ªô</p>
                  <h3 className="text-xl font-bold text-[#004488]">{currentRank.title}</h3>
              </div>
            </div>
            <div className="mb-2 flex justify-between text-xs font-bold text-slate-500">
              <span>{xp} XP</span>
              <span>Next: {xpForNextLevel} XP</span>
            </div>
            <div className="w-full bg-slate-200 rounded-full h-3 mb-4">
              <div className="bg-gradient-to-r from-blue-500 to-purple-500 h-3 rounded-full transition-all duration-700" style={{ width: `${xpProgress}%` }}></div>
            </div>
            {/* Weekly Activity Bubbles */}
            <div className="mt-4 pt-4 border-t border-slate-100">
               <p className="text-xs text-slate-400 font-bold uppercase mb-2">Ho·∫°t ƒë·ªông tu·∫ßn n√†y</p>
               <div className="flex justify-between">
                  {['T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'CN'].map((day, idx) => (
                     <div key={idx} className="flex flex-col items-center">
                        <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold transition-all duration-300 ${weeklyActivity[idx] ? 'bg-green-500 text-white shadow-md scale-110' : 'bg-slate-100 text-slate-300'}`}>
                           {weeklyActivity[idx] && <CheckCircle className="w-4 h-4" />}
                        </div>
                        <span className="text-[10px] text-slate-400 mt-1">{day}</span>
                     </div>
                  ))}
               </div>
            </div>
            {/* Badges Button */}
            <div className="flex gap-2 justify-center mt-4">
              {[5, 10, 20].map((badgeLvl, idx) => (
                <button 
                  key={idx}
                  onClick={() => setShowBadgeDetails(badgeLvl)}
                  title={`Level ${badgeLvl}`} 
                  className={`w-10 h-10 rounded-full flex items-center justify-center transition hover:scale-110 ${level >= badgeLvl ? 'bg-amber-100 text-amber-600 border border-amber-300' : 'bg-slate-100 text-slate-300'}`}
                >
                  {badgeLvl === 5 ? <Medal className="w-6 h-6"/> : badgeLvl === 10 ? <Star className="w-6 h-6"/> : <Trophy className="w-6 h-6"/>}
                </button>
              ))}
            </div>
          </div>
      </div>

      {/* LEADERBOARD */}
      <div className="bg-white p-6 rounded-2xl shadow-lg border border-slate-100 mb-6">
          <div className="flex justify-between items-center mb-4">
             <h3 className="font-bold text-[#004488] uppercase flex items-center"><Trophy className="w-5 h-5 mr-2 text-gold" /> B·∫£ng Phong Th·∫ßn</h3>
             <span className="text-xs text-slate-400 font-bold bg-slate-100 px-2 py-1 rounded-full">Tu·∫ßn n√†y</span>
          </div>
          <div className="space-y-3">
              {getLeaderboard().map((u, idx) => (
                  <div key={u.id} className={`flex items-center justify-between p-3 rounded-xl transition hover:scale-[1.02] ${u.isUser ? 'bg-blue-50 border border-blue-200 shadow-sm' : 'bg-slate-50'}`}>
                      <div className="flex items-center">
                          <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold mr-3 border-2 ${idx === 0 ? 'bg-yellow-100 text-yellow-600 border-yellow-300' : idx === 1 ? 'bg-gray-200 text-gray-600 border-gray-300' : idx === 2 ? 'bg-orange-100 text-orange-600 border-orange-300' : 'bg-white text-slate-500 border-slate-200'}`}>
                              {idx + 1}
                          </div>
                          <span className={`font-bold ${u.isUser ? 'text-[#004488]' : 'text-slate-700'}`}>{u.name} {u.isUser && "(B·∫°n)"}</span>
                      </div>
                      <span className="font-bold text-slate-500 text-xs">{u.xp.toLocaleString()} XP</span>
                  </div>
              ))}
          </div>
      </div>
      
      {/* Daily Progress */}
      <div className="bg-white p-6 rounded-2xl shadow-lg border-t-4 border-green-500 relative overflow-hidden mb-6">
          <div className="flex justify-between items-center mb-2">
            <h3 className="font-bold text-slate-700 uppercase flex items-center"><Target className="w-5 h-5 mr-2 text-green-600" /> M·ª•c ti√™u ng√†y</h3>
            <span className="text-xs font-bold text-slate-500">{wordsToday}/{DAILY_GOAL} t·ª´</span>
          </div>
          <div className="w-full bg-slate-200 rounded-full h-4 mb-4">
            <div className="bg-green-500 h-4 rounded-full transition-all duration-500" style={{ width: `${Math.min((wordsToday / DAILY_GOAL) * 100, 100)}%` }}></div>
          </div>
          {wordsToday >= DAILY_GOAL && (
            <div className="text-center bg-green-50 text-green-700 p-2 rounded-lg font-bold text-sm animate-pulse">üéâ Xu·∫•t s·∫Øc! +{XP_REWARDS.DAILY_GOAL_MET} XP</div>
          )}
      </div>
    </>
  );

  const renderSearchSection = () => (
    <div className="bg-white p-6 rounded-2xl shadow-lg border border-slate-100 mb-6">
      <h2 className="text-lg font-bold text-[#004488] mb-4 uppercase flex items-center">
        <Search className="w-5 h-5 mr-2 text-amber-500" /> Tra t·ª´ th√¥ng minh
      </h2>
      <form onSubmit={(e) => handleSearch(e)} className="space-y-4">
        <input type="text" value={inputWord} onChange={(e) => setInputWord(e.target.value)} placeholder="Nh·∫≠p t·ª´ v·ª±ng..." className="w-full px-4 py-3 text-lg border-2 border-slate-200 rounded-xl focus:border-[#004488] outline-none transition font-medium" />
        <button type="submit" disabled={loading} className={`w-full py-3 px-6 bg-amber-400 hover:bg-amber-300 text-[#004488] font-bold text-lg uppercase rounded-xl shadow-[0_4px_0_rgb(180,83,9)] hover:translate-y-[2px] transition-all flex justify-center items-center ${loading ? 'opacity-70' : ''}`}>
          {loading ? <RefreshCw className="animate-spin w-6 h-6" /> : <><Sparkles className="w-5 h-5 mr-2" /> Ph√¢n T√≠ch AI (+15 XP)</>}
        </button>
      </form>
    </div>
  );

  const renderHistorySection = () => (
    <div className="bg-white p-6 rounded-2xl shadow-lg border border-slate-100 mb-6">
        <div className="flex justify-between items-center mb-4">
            <h3 className="text-sm font-bold text-slate-400 uppercase flex items-center"><History className="w-4 h-4 mr-1" /> Kho t·ª´ ƒë√£ h·ªçc</h3>
            <div className="flex space-x-1">
              <button onClick={startSpeedReview} className="p-2 bg-orange-50 text-orange-600 rounded hover:bg-orange-100 transition flex items-center space-x-1" title="Th·ª≠ th√°ch t·ªëc ƒë·ªô"><Timer className="w-4 h-4" /> <span className="text-xs font-bold hidden sm:inline">T·ªëc ƒë·ªô</span></button>
              <button onClick={() => { setCurrentCardIndex(0); setIsFlipped(false); setShowFlashcards(true); }} className="p-2 bg-blue-50 text-[#004488] rounded hover:bg-blue-100 transition flex items-center space-x-1" title="√în t·∫≠p Flashcard"><Layers className="w-4 h-4" /> <span className="text-xs font-bold hidden sm:inline">Flashcard</span></button>
              <button onClick={exportToExcel} className="p-2 bg-green-50 text-green-600 rounded hover:bg-green-100 transition flex items-center space-x-1" title="Xu·∫•t Excel"><FileSpreadsheet className="w-4 h-4" /> <span className="text-xs font-bold hidden sm:inline">Excel</span></button>
            </div>
        </div>
        <div className="flex flex-wrap gap-2 max-h-60 overflow-y-auto">
          {history.length > 0 ? history.map((item, idx) => (
              <button key={idx} onClick={() => handleSearch(null, item.word)} className="px-3 py-1 bg-slate-100 hover:bg-[#004488] hover:text-white text-slate-600 rounded-full text-sm font-medium transition cursor-pointer">{item.word}</button>
          )) : <p className="text-sm text-slate-400 italic">Ch∆∞a c√≥ l·ªãch s·ª≠. H√£y tra t·ª´ ƒë·ªÉ l√†m gi√†u kho t·ª´ v·ª±ng!</p>}
        </div>
    </div>
  );

  const renderResultSection = () => (
    <div ref={resultRef}>
      {!result && !loading && (
        <div className="h-full flex flex-col items-center justify-center py-6 lg:py-16 space-y-8 animate-fade-in-up">
          
          {/* Quote of the Day */}
          <div className="w-full max-w-2xl text-center px-6">
             <Quote className="w-10 h-10 text-amber-300 mx-auto mb-2 opacity-50" />
             <p className="text-xl font-serif text-slate-600 italic">"{dailyQuote.text}"</p>
             <p className="text-sm font-bold text-[#004488] mt-2 uppercase tracking-widest">‚Äî {dailyQuote.author}</p>
          </div>

          {/* SMART REVIEW CARD */}
          {reviewSuggestion && (
             <div className="w-full max-w-md bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-100 flex items-center justify-between cursor-pointer hover:shadow-md transition" onClick={() => handleSearch(null, reviewSuggestion.word)}>
                <div className="flex items-center">
                   <div className="bg-white p-2 rounded-full mr-3 shadow-sm"><RefreshCw className="w-5 h-5 text-blue-500" /></div>
                   <div>
                      <p className="text-xs text-slate-400 uppercase font-bold">G√≥c √¥n t·∫≠p</p>
                      <p className="font-bold text-[#004488] text-lg">"{reviewSuggestion.word}"</p>
                   </div>
                </div>
                <ArrowRight className="w-5 h-5 text-blue-300" />
             </div>
          )}

          {/* Daily Word Feature */}
          <div className="w-full max-w-md bg-white p-6 rounded-2xl shadow-xl border-t-4 border-orange-400 transform transition hover:scale-105 duration-300 relative group cursor-pointer" onClick={() => handleSearch(null, dailyWord)}>
              <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-100 transition duration-500">
                 <Sparkles className="w-8 h-8 text-orange-400 animate-pulse" />
              </div>
              <div className="flex justify-between items-center mb-4">
                 <h3 className="font-bold text-[#004488] uppercase flex items-center"><Calendar className="w-5 h-5 mr-2 text-orange-500" /> T·ª´ c·ªßa h√¥m nay</h3>
                 <span className="text-xs font-bold bg-orange-100 text-orange-600 px-2 py-1 rounded">{new Date().toLocaleDateString('vi-VN')}</span>
              </div>
              <div className="text-center py-4">
                 <p className="text-4xl font-bold text-[#004488] mb-2">{dailyWord}</p>
                 <span className="text-sm text-slate-400 italic">Nh·∫•n ƒë·ªÉ h·ªçc ngay</span>
              </div>
          </div>
          
          <div className="flex flex-wrap justify-center gap-2 max-w-lg">
             {["Serendipity", "Ephemeral", "Pragmatic", "Alacrity"].map(w => (
                w !== dailyWord && (
                   <button key={w} onClick={() => handleSearch(null, w)} className="px-3 py-1 bg-white border border-slate-200 text-slate-500 rounded-full text-sm hover:border-[#004488] hover:text-[#004488] transition">{w}</button>
                )
             ))}
          </div>
        </div>
      )}
      
      {loading && (
        <div className="space-y-6">
            <div className="h-40 bg-slate-200 animate-pulse rounded-2xl w-full"></div>
            <div className="h-64 bg-slate-200 animate-pulse rounded-2xl w-full"></div>
            <div className="text-center text-slate-400 animate-bounce text-sm">AI ƒëang chu·∫©n b·ªã n·ªôi dung chu·∫©n "Th·ªß Khoa"...</div>
        </div>
      )}

      {result && !loading && (
        <div className="space-y-8 animate-fade-in-up pb-24 lg:pb-0">
          {/* HERO CARD */}
          <div className="relative overflow-hidden rounded-2xl shadow-xl bg-[#004488] group">
            <div className="absolute top-0 right-0 w-64 h-64 bg-amber-400 opacity-10 rounded-full blur-3xl group-hover:opacity-20 transition-opacity"></div>
            <div className="p-8 md:p-10 relative z-10 text-white">
              <div className="flex justify-between items-start">
                <div>
                  <span className="inline-block px-3 py-1 bg-white/20 rounded-full text-xs font-bold tracking-widest uppercase mb-3 text-amber-300">{result.type}</span>
                  <h1 className="text-5xl md:text-6xl font-bold text-white mb-2 tracking-tight">{result.word}</h1>
                  <div className="flex items-center space-x-3 text-slate-300 text-xl font-serif italic">
                    <span>{result.phonetic}</span>
                    <button onClick={() => playAudio(result.word)} className="p-2 bg-white/10 rounded-full hover:bg-amber-500 hover:text-[#004488] transition"><Volume2 className="w-5 h-5" /></button>
                  </div>
                </div>
                <div className="hidden md:block"><div className="w-16 h-16 bg-white/10 rounded-full flex items-center justify-center border border-white/20 shadow-inner"><Star className="w-8 h-8 text-[#FFD700]" fill="#FFD700" /></div></div>
              </div>
              <div className="mt-8 pt-6 border-t border-white/10"><p className="text-2xl md:text-3xl font-serif text-amber-200 leading-relaxed">"{result.vietnamese}"</p></div>
            </div>
          </div>

          {/* BLURB & ORIGIN */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div className="bg-white rounded-2xl shadow-md border-l-8 border-amber-400 p-6">
                  <div className="flex items-center mb-4"><MessageCircle className="w-6 h-6 text-amber-600 mr-2" /><h3 className="text-lg font-bold text-[#004488] uppercase">The Blurb</h3></div>
                  <p className="text-lg text-slate-700 font-serif leading-relaxed">{result.blurb}</p>
              </div>
              <div className="bg-white rounded-2xl shadow-md border-l-8 border-slate-400 p-6">
                  <div className="flex items-center mb-4"><BookOpen className="w-6 h-6 text-slate-600 mr-2" /><h3 className="text-lg font-bold text-[#004488] uppercase">G·ªëc t·ª´ (Origin)</h3></div>
                  <p className="text-lg text-slate-700 font-serif leading-relaxed italic">{result.origin || "ƒêang c·∫≠p nh·∫≠t..."}</p>
              </div>
          </div>

          {/* SYNONYMS & ANTONYMS */}
          {(result.synonyms?.length > 0 || result.antonyms?.length > 0) && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
               <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
                  <h4 className="font-bold text-[#004488] uppercase text-sm mb-3 flex items-center">
                    <span className="w-2 h-2 rounded-full bg-green-500 mr-2"></span> T·ª´ ƒê·ªìng Nghƒ©a (Synonyms)
                  </h4>
                  <div className="flex flex-wrap gap-2">
                    {result.synonyms?.map((syn, i) => (
                      <button key={i} onClick={() => handleSearch(null, syn)} className="px-3 py-1 bg-green-50 text-green-700 rounded-lg text-sm font-medium border border-green-100 hover:bg-green-100 transition">{syn}</button>
                    ))}
                  </div>
               </div>
               <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
                  <h4 className="font-bold text-[#004488] uppercase text-sm mb-3 flex items-center">
                    <span className="w-2 h-2 rounded-full bg-red-500 mr-2"></span> T·ª´ Tr√°i Nghƒ©a (Antonyms)
                  </h4>
                  <div className="flex flex-wrap gap-2">
                    {result.antonyms?.map((ant, i) => (
                      <button key={i} onClick={() => handleSearch(null, ant)} className="px-3 py-1 bg-red-50 text-red-700 rounded-lg text-sm font-medium border border-red-100 hover:bg-red-100 transition">{ant}</button>
                    ))}
                  </div>
               </div>
            </div>
          )}

          {/* EXAMPLES */}
          {result.examples && result.examples.length > 0 && (
            <div className="bg-white rounded-2xl shadow-md p-6 md:p-8">
              <h3 className="text-xl font-bold text-[#004488] uppercase mb-4">Ng·ªØ c·∫£nh & VƒÉn h·ªçc</h3>
              <div className="grid gap-4">
                {result.examples.map((ex, idx) => (
                  <div key={idx} className="group relative pl-6 border-l-4 border-slate-200 hover:border-[#004488] transition-colors py-2">
                    <p className="text-xs font-bold text-amber-600 uppercase tracking-wider mb-1">{ex.type}</p>
                    <p className="text-lg text-slate-800 italic font-serif leading-relaxed">"{ex.text}"</p>
                    <p className="text-right text-xs text-slate-400 font-bold mt-2 uppercase flex justify-end items-center"><span className="w-8 h-[1px] bg-slate-300 mr-2"></span> {ex.source}</p>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* MULTI-LEVEL QUIZ */}
          {(result.quizzes || result.quiz) && (
            <div className="bg-slate-900 rounded-2xl shadow-xl p-6 md:p-8 text-white relative overflow-hidden transition-all duration-300">
              <div className="flex justify-between items-center mb-6 relative z-10">
                <h3 className="text-xl font-bold text-[#FFD700] uppercase flex items-center"><Brain className="w-6 h-6 mr-2" /> Th√°p Ki·∫øn Th·ª©c</h3>
                <button onClick={() => { setQuizMode(!quizMode); setCurrentQuizIndex(0); setQuizStatus({}); }} className="text-xs font-bold bg-white/10 hover:bg-white/20 px-3 py-1 rounded-full transition">{quizMode ? "·∫®n" : "Hi·ªán"}</button>
              </div>

              {(() => {
                  const quizzes = result.quizzes || (result.quiz ? [result.quiz] : []);
                  if (quizzes.length === 0) return null;
                  const currentQuiz = quizzes[currentQuizIndex];
                  
                  return !quizMode ? (
                    <div className="text-center py-4">
                      <p className="text-slate-300 mb-4">Chinh ph·ª•c 3 c·∫•p ƒë·ªô ƒë·ªÉ nh·∫≠n t·ªëi ƒëa XP!</p>
                      <button onClick={() => setQuizMode(true)} className="px-8 py-3 bg-[#004488] hover:bg-blue-700 text-white font-bold rounded-xl border border-blue-500 transition shadow-lg">B·∫Øt ƒë·∫ßu Quiz</button>
                    </div>
                  ) : (
                    <div className="animate-fade-in relative z-10">
                      <div className="flex justify-between items-center mb-4 text-sm font-bold text-slate-400">
                         <span className={`px-2 py-1 rounded ${currentQuizIndex === 0 ? 'bg-green-900 text-green-300' : currentQuizIndex === 1 ? 'bg-yellow-900 text-yellow-300' : 'bg-red-900 text-red-300'}`}>
                            Level {currentQuizIndex + 1}: {currentQuiz.level || (currentQuizIndex === 0 ? 'D·ªÖ' : currentQuizIndex === 1 ? 'Trung B√¨nh' : 'Kh√≥')}
                         </span>
                         <span>C√¢u h·ªèi {currentQuizIndex + 1}/{quizzes.length}</span>
                      </div>
                      
                      <p className="text-lg font-serif mb-6 leading-relaxed bg-white/5 p-4 rounded-lg border-l-4 border-amber-500">
                         {currentQuiz.question}
                      </p>

                      <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-6">
                        {currentQuiz.options.map((option, idx) => {
                          const status = quizStatus[currentQuizIndex];
                          let btnClass = 'bg-white/5 border-white/10 hover:bg-white/10 hover:border-amber-400';
                          if (status === 'correct' && option.trim().toLowerCase() === currentQuiz.answer.trim().toLowerCase()) {
                              btnClass = 'bg-green-600/30 border-green-500 text-green-100';
                          } 
                          return (
                            <button key={idx} onClick={() => handleQuizAnswer(option)} disabled={status === 'correct'} className={`p-4 rounded-xl text-left font-medium transition-all duration-200 border-2 ${btnClass}`}>
                              <div className="flex justify-between items-center">
                                <span>{option}</span>
                                {status === 'correct' && option.trim().toLowerCase() === currentQuiz.answer.trim().toLowerCase() && <CheckCircle className="w-5 h-5 text-green-400" />}
                              </div>
                            </button>
                          );
                        })}
                      </div>

                      {quizStatus[currentQuizIndex] && (
                        <div className="space-y-4 animate-pop-in">
                           <div className={`p-4 rounded-xl border-l-4 ${quizStatus[currentQuizIndex] === 'correct' ? 'bg-green-900/40 border-green-500' : 'bg-slate-800 border-amber-500'}`}>
                             <div className="flex items-center mb-2 font-bold text-sm uppercase tracking-wider">
                                {quizStatus[currentQuizIndex] === 'correct' ? <><span className="text-green-400 mr-2">Ch√≠nh x√°c!</span> <span className="text-gold">+{currentQuizIndex === 0 ? 10 : currentQuizIndex === 1 ? 20 : 30} XP</span></> : <span className="text-amber-400 flex items-center"><Lightbulb className="w-4 h-4 mr-1"/> Gi·∫£i th√≠ch chi ti·∫øt</span>}
                             </div>
                             <p className="text-slate-200 font-serif leading-relaxed">{currentQuiz.explanation}</p>
                           </div>
                           
                           <div className="flex justify-between mt-4">
                              <button disabled={currentQuizIndex === 0} onClick={() => setCurrentQuizIndex(prev => prev - 1)} className="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 disabled:opacity-30 transition flex items-center"><ChevronLeft className="w-4 h-4 mr-1" /> Tr∆∞·ªõc</button>
                              <button disabled={currentQuizIndex === quizzes.length - 1} onClick={() => setCurrentQuizIndex(prev => prev + 1)} className={`px-4 py-2 rounded-lg transition flex items-center font-bold ${quizStatus[currentQuizIndex] === 'correct' ? 'bg-green-600 hover:bg-green-500' : 'bg-white/10 hover:bg-white/20'}`}>{currentQuizIndex < quizzes.length - 1 ? "C√¢u ti·∫øp theo" : "Ho√†n th√†nh"} <ChevronRight className="w-4 h-4 ml-1" /></button>
                           </div>
                        </div>
                      )}
                    </div>
                  );
              })()}
            </div>
          )}

          {/* SUGGESTIONS */}
          {result.suggestions && result.suggestions.length > 0 && (
            <div className="mt-8">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-xl font-bold text-[#004488] uppercase flex items-center"><Map className="w-6 h-6 mr-2 text-amber-500" /> H√†nh tr√¨nh ti·∫øp theo</h3>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                {result.suggestions.map((word, idx) => (
                  <button key={idx} onClick={() => handleSearch(null, word)} className="bg-white p-4 rounded-xl shadow-md border-2 border-slate-100 hover:border-amber-400 hover:shadow-lg transition group text-left relative overflow-hidden">
                    <div className="absolute top-0 right-0 w-16 h-16 bg-slate-50 rounded-full -translate-y-1/2 translate-x-1/2 group-hover:bg-amber-100 transition"></div>
                    <p className="text-xs text-slate-400 font-bold uppercase mb-1 relative z-10">G·ª£i √Ω {idx + 1}</p>
                    <p className="text-lg font-bold text-[#004488] group-hover:text-amber-600 transition relative z-10 flex items-center justify-between">{word}<ArrowRight className="w-4 h-4 opacity-0 group-hover:opacity-100 transition -translate-x-2 group-hover:translate-x-0" /></p>
                  </button>
                ))}
              </div>
            </div>
          )}
        </div>
      )}
    </div>
  );

  return (
    <div className="min-h-screen bg-slate-50 font-serif text-slate-800 relative" ref={topRef}>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;0,700;1,400&display=swap');
        .font-serif { font-family: 'Crimson Pro', serif; }
        .text-gold { color: #FFD700; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .backface-hidden { backface-visibility: hidden; }
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(5deg); } 75% { transform: rotate(-5deg); } 100% { transform: rotate(0deg); } }
        .shake-animation { animation: shake 2s infinite; }
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 70% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
        .animate-pop-in { animation: popIn 0.5s ease-out forwards; }
        @keyframes floatUp { 0% { transform: translateY(20px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
        .animate-float-up { animation: floatUp 0.3s ease-out forwards; }
        .logo-glow { box-shadow: 0 0 15px rgba(255, 215, 0, 0.5), inset 0 0 10px rgba(0, 68, 136, 0.3); }
      `}</style>

      {/* NOTIFICATIONS & MODALS */}
      {notification && (
        <div className="fixed top-24 right-4 z-[70] animate-float-up bg-white border-l-4 border-green-500 shadow-xl rounded-lg p-4 flex items-center pr-8">
           <div className={`p-1 rounded-full mr-3 ${notification.type === 'success' ? 'bg-green-100 text-green-600' : 'bg-blue-100 text-blue-600'}`}>{notification.type === 'success' ? <CheckCircle className="w-5 h-5"/> : <Zap className="w-5 h-5"/>}</div>
           <span className="font-bold text-slate-700">{notification.message}</span>
        </div>
      )}

      {/* Daily Login Bonus Modal */}
      {showDailyBonus && (
        <div className="fixed inset-0 z-[90] bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm" onClick={() => setShowDailyBonus(false)}>
           <div className="bg-white rounded-3xl p-8 text-center max-w-sm w-full animate-pop-in relative overflow-hidden" onClick={e => e.stopPropagation()}>
              <div className="absolute inset-0 pointer-events-none">{[...Array(30)].map((_, i) => (<div key={i} className="absolute w-2 h-2 rounded-full" style={{ backgroundColor: ['#FFD700', '#004488', '#FF4500'][i % 3], left: `${Math.random() * 100}%`, top: `${Math.random() * 100}%`, animation: `floatUp ${1 + Math.random()}s infinite` }}></div>))}</div>
              <Gift className="w-20 h-20 text-orange-500 mx-auto mb-4 drop-shadow-lg animate-bounce" />
              <h2 className="text-2xl font-bold text-[#004488] mb-2 uppercase">Ch√†o ng√†y m·ªõi!</h2>
              <p className="text-lg text-slate-600 mb-6">B·∫°n nh·∫≠n ƒë∆∞·ª£c ph·∫ßn qu√† ƒëi·ªÉm danh.</p>
              <div className="bg-orange-50 p-4 rounded-xl mb-6 border border-orange-200">
                <p className="text-3xl font-bold text-orange-600">+{XP_REWARDS.DAILY_LOGIN} XP</p>
              </div>
              <button onClick={claimDailyBonus} className="w-full py-3 bg-[#004488] text-white font-bold rounded-xl hover:bg-blue-700 transition">Nh·∫≠n th∆∞·ªüng ngay</button>
           </div>
        </div>
      )}

      {/* Badge Details Modal */}
      {showBadgeDetails && (
        <div className="fixed inset-0 z-[85] bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm" onClick={() => setShowBadgeDetails(null)}>
           <div className="bg-white rounded-3xl p-8 text-center max-w-sm w-full animate-pop-in" onClick={e => e.stopPropagation()}>
              <div className={`w-20 h-20 mx-auto mb-4 rounded-full flex items-center justify-center border-4 ${level >= showBadgeDetails ? 'bg-amber-100 text-amber-600 border-amber-400' : 'bg-slate-100 text-slate-300 border-slate-300'}`}>
                 {showBadgeDetails === 5 ? <Medal className="w-10 h-10"/> : showBadgeDetails === 10 ? <Star className="w-10 h-10"/> : <Trophy className="w-10 h-10"/>}
              </div>
              <h2 className="text-xl font-bold text-[#004488] mb-2">Huy Hi·ªáu Level {showBadgeDetails}</h2>
              <p className="text-slate-600 mb-6">
                {level >= showBadgeDetails ? "B·∫°n ƒë√£ m·ªü kh√≥a huy hi·ªáu n√†y. Xu·∫•t s·∫Øc!" : `C·∫ßn ƒë·∫°t Level ${showBadgeDetails} ƒë·ªÉ m·ªü kh√≥a. H√£y ti·∫øp t·ª•c h·ªçc nh√©!`}
              </p>
              <button onClick={() => setShowBadgeDetails(null)} className="px-6 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-slate-600 font-bold transition">ƒê√≥ng</button>
           </div>
        </div>
      )}

      {showLevelUp && (
        <div className="fixed inset-0 z-[80] bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm" onClick={() => setShowLevelUp(false)}>
           <div className="bg-white rounded-3xl p-8 text-center max-w-md w-full animate-pop-in relative overflow-hidden" onClick={e => e.stopPropagation()}>
              <div className="absolute inset-0 pointer-events-none">{[...Array(20)].map((_, i) => (<div key={i} className="absolute w-2 h-2 rounded-full" style={{ backgroundColor: ['#FFD700', '#004488', '#FF4500', '#32CD32'][i % 4], left: `${Math.random() * 100}%`, top: `${Math.random() * 100}%`, animation: `floatUp ${1 + Math.random()}s infinite` }}></div>))}</div>
              <Crown className="w-20 h-20 text-gold mx-auto mb-4 drop-shadow-lg" />
              <h2 className="text-3xl font-bold text-[#004488] mb-2 uppercase">ThƒÉng C·∫•p!</h2>
              <p className="text-xl font-bold text-slate-600 mb-6">Ch√†o m·ª´ng ƒë·∫øn v·ªõi Level {level}</p>
              <div className="bg-blue-50 p-4 rounded-xl mb-6 border border-blue-100"><p className="text-sm text-slate-500 uppercase font-bold mb-1">Danh hi·ªáu m·ªõi</p><p className="text-2xl font-bold text-amber-500">{getCurrentRank().title}</p></div>
              <button onClick={() => setShowLevelUp(false)} className="w-full py-3 bg-[#004488] text-white font-bold rounded-xl hover:bg-blue-700 transition">Ti·∫øp t·ª•c chinh ph·ª•c</button>
           </div>
        </div>
      )}

      {/* Speed Review Modal (Fixed z-index and Notification) */}
      {speedReviewMode && (
        <div className="fixed inset-0 z-[100] bg-slate-900/95 flex items-center justify-center p-4">
           <div className="bg-white w-full max-w-2xl rounded-3xl shadow-2xl overflow-hidden relative min-h-[400px] flex flex-col animate-pop-in">
              <div className="p-4 bg-[#004488] text-white flex justify-between items-center">
                 <h3 className="font-bold flex items-center"><Timer className="w-5 h-5 mr-2" /> Th·ª≠ Th√°ch T·ªëc ƒê·ªô</h3>
                 <div className="flex items-center space-x-4">
                    <div className="flex items-center"><Clock className="w-4 h-4 mr-1 text-amber-400" /> <span className="font-mono font-bold text-xl">{speedReviewData.timeLeft}s</span></div>
                    <button onClick={() => setSpeedReviewMode(false)}><X className="w-6 h-6" /></button>
                 </div>
              </div>
              
              <div className="flex-1 p-8 flex flex-col items-center justify-center">
                 {!speedReviewData.isFinished ? (
                    <>
                       <div className="mb-8 text-center">
                          <p className="text-slate-400 text-sm uppercase font-bold mb-2">C√¢u {speedReviewData.currentIndex + 1}/{speedReviewData.questions.length}</p>
                          <h2 className="text-4xl font-bold text-[#004488] mb-4">{speedReviewData.questions[speedReviewData.currentIndex]?.word}</h2>
                       </div>
                       <div className="grid grid-cols-1 md:grid-cols-2 gap-4 w-full">
                          {speedReviewData.questions[speedReviewData.currentIndex]?.options.map((opt, idx) => (
                             <button 
                               key={idx}
                               onClick={() => handleSpeedAnswer(opt)}
                               className="p-4 rounded-xl border-2 border-slate-200 hover:border-[#004488] hover:bg-blue-50 transition text-left font-medium text-slate-700"
                             >
                               {opt}
                             </button>
                          ))}
                       </div>
                    </>
                 ) : (
                    <div className="text-center animate-pop-in">
                       <Trophy className="w-24 h-24 text-gold mx-auto mb-4" />
                       <h2 className="text-3xl font-bold text-[#004488] mb-2">Ho√†n Th√†nh!</h2>
                       <p className="text-xl text-slate-600 mb-6">B·∫°n tr·∫£ l·ªùi ƒë√∫ng <span className="font-bold text-green-600">{speedReviewData.score}/{speedReviewData.questions.length}</span> c√¢u.</p>
                       <div className="bg-orange-50 p-4 rounded-xl mb-6 border border-orange-200">
                          <p className="text-sm text-slate-500 uppercase font-bold mb-1">Ph·∫ßn th∆∞·ªüng</p>
                          <p className="text-3xl font-bold text-orange-600">+{speedReviewData.score * XP_REWARDS.SPEED_REVIEW_CORRECT} XP</p>
                       </div>
                       <button onClick={() => { addXP(speedReviewData.score * XP_REWARDS.SPEED_REVIEW_CORRECT); setSpeedReviewMode(false); }} className="px-8 py-3 bg-[#004488] text-white font-bold rounded-xl hover:bg-blue-700 transition">Nh·∫≠n th∆∞·ªüng & ƒê√≥ng</button>
                    </div>
                 )}
              </div>
           </div>
        </div>
      )}

      {showFlashcards && history.length > 0 && (
        <div className="fixed inset-0 z-[60] bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
          <div className="bg-white w-full max-w-2xl rounded-3xl shadow-2xl overflow-hidden relative min-h-[400px] flex flex-col animate-pop-in">
            <div className="p-4 border-b flex justify-between items-center bg-slate-50">
              <h3 className="font-bold text-[#004488] flex items-center"><Layers className="w-5 h-5 mr-2" /> Flashcard ({currentCardIndex + 1}/{history.length})</h3>
              <button onClick={() => setShowFlashcards(false)} className="p-2 hover:bg-slate-200 rounded-full transition"><X className="w-6 h-6 text-slate-500" /></button>
            </div>
            <div className="flex-1 p-8 perspective-1000 flex items-center justify-center cursor-pointer" onClick={() => setIsFlipped(!isFlipped)}>
              <div className={`relative w-full h-64 transition-transform duration-500 transform-style-3d ${isFlipped ? 'rotate-y-180' : ''}`}>
                <div className={`absolute inset-0 bg-gradient-to-br from-[#004488] to-[#003366] rounded-2xl flex flex-col items-center justify-center text-white backface-hidden p-6 shadow-xl ${isFlipped ? 'hidden' : 'flex'}`}>
                  <h2 className="text-4xl md:text-5xl font-bold mb-4 text-center">{history[currentCardIndex].word}</h2>
                  <div className="flex items-center space-x-2 bg-white/20 px-4 py-2 rounded-full cursor-pointer hover:bg-white/30 transition" onClick={(e) => { e.stopPropagation(); playAudio(history[currentCardIndex].word); }}><Volume2 className="w-5 h-5" /><span className="font-serif italic text-lg">{history[currentCardIndex].phonetic}</span></div>
                  <p className="mt-8 text-sm text-slate-300 uppercase tracking-widest animate-pulse">Nh·∫•n ƒë·ªÉ l·∫≠t th·∫ª</p>
                </div>
                <div className={`absolute inset-0 bg-white border-4 border-[#004488] rounded-2xl flex flex-col items-center justify-center text-center backface-hidden rotate-y-180 p-6 shadow-xl ${isFlipped ? 'flex' : 'hidden'}`}>
                  <h3 className="text-2xl font-bold text-[#004488] mb-2">{history[currentCardIndex].vietnamese}</h3>
                  <p className="text-slate-600 italic mb-4 font-serif px-4">"{history[currentCardIndex].origin || "..."}"</p>
                  <div className="w-12 h-1 bg-amber-400 mb-4 rounded-full"></div>
                  <p className="text-sm text-slate-500 line-clamp-3">{history[currentCardIndex].examples?.[0]?.text}</p>
                </div>
              </div>
            </div>
            <div className="p-6 bg-slate-50 border-t flex justify-between items-center">
              <button disabled={currentCardIndex === 0} onClick={() => { setCurrentCardIndex(c => c - 1); setIsFlipped(false); }} className="p-3 rounded-full bg-white border hover:bg-slate-100 disabled:opacity-50"><ChevronLeft className="w-6 h-6 text-[#004488]" /></button>
              <button disabled={currentCardIndex === history.length - 1} onClick={() => { setCurrentCardIndex(c => c + 1); setIsFlipped(false); }} className="p-3 rounded-full bg-white border hover:bg-slate-100 disabled:opacity-50"><ChevronRight className="w-6 h-6 text-[#004488]" /></button>
            </div>
          </div>
        </div>
      )}

      {/* HEADER */}
      <header className="sticky top-0 z-50 bg-white border-b-4 border-gold shadow-md">
        <div className="container mx-auto px-4 py-3 flex justify-between items-center">
          <div className="flex items-center space-x-3">
            <div className="relative group cursor-pointer" onClick={() => { window.location.reload(); }}>
               <div className="absolute -inset-1 bg-gradient-to-r from-[#FFD700] to-amber-600 rounded-full blur opacity-40 group-hover:opacity-75 transition duration-1000 group-hover:duration-200"></div>
               <div className="relative rounded-full overflow-hidden border-[3px] border-[#004488] shadow-xl w-14 h-14 bg-white flex items-center justify-center logo-glow">
                  <img src="https://d21acfi38wn3iy.cloudfront.net/resource/documents/9d2dd8b7-2de4-4dea-9c36-f8a2abc3dece/1761724790727-anh-group-fb-png.png" alt="Logo" className="w-full h-full object-cover scale-110 transition-transform duration-500 group-hover:scale-125" />
               </div>
            </div>
            <div>
              <h1 className="text-xl md:text-2xl font-bold text-[#004488] uppercase tracking-wide leading-none drop-shadow-sm">SAT Th·ªß Khoa</h1>
              <span className="text-xs md:text-sm text-slate-500 font-medium tracking-widest uppercase">ƒê·ª©c An ‚Ä¢ Education</span>
            </div>
          </div>
          <div className="flex items-center space-x-4">
             <div className="hidden md:flex items-center px-3 py-1 bg-orange-50 text-orange-600 rounded-full border border-orange-200" title="Chu·ªói ng√†y h·ªçc li√™n ti·∫øp">
                <Flame className={`w-5 h-5 mr-1 ${streak > 0 ? 'fill-orange-500' : 'text-slate-300'}`} />
                <span className="font-bold">{streak} Ng√†y</span>
             </div>
            <nav className="hidden md:block">
                <a href="https://SATFelis.Izteach.vn" target="_blank" rel="noopener noreferrer" className="flex items-center space-x-2 bg-[#004488] text-white px-5 py-2 rounded-full font-bold shadow-md hover:bg-amber-500 hover:text-[#004488] transition-all transform hover:-translate-y-0.5"><span>Website Ch√≠nh Th·ª©c</span><ExternalLink className="w-4 h-4" /></a>
            </nav>
          </div>
        </div>
      </header>

      {/* MAIN CONTENT AREA */}
      <main className="container mx-auto px-4 py-6 md:py-8 pb-24 md:pb-8">
        
        {/* DESKTOP LAYOUT (Grid) - HIDDEN ON MOBILE */}
        <div className="hidden lg:grid lg:grid-cols-12 lg:gap-8">
          <div className="lg:col-span-4 space-y-6">
            {renderProfileSection()}
            {renderSearchSection()}
            {renderHistorySection()}
          </div>
          <div className="lg:col-span-8">
            {renderResultSection()}
          </div>
        </div>

        {/* MOBILE LAYOUT (Tabs) - VISIBLE ON MOBILE ONLY */}
        <div className="lg:hidden block space-y-6">
          {activeTab === 'study' && (
             <div className="animate-fade-in">
                {renderSearchSection()}
                {renderResultSection()}
             </div>
          )}
          {activeTab === 'stats' && (
             <div className="animate-fade-in">
                {renderProfileSection()}
             </div>
          )}
          {activeTab === 'library' && (
             <div className="animate-fade-in">
                {renderHistorySection()}
             </div>
          )}
        </div>

      </main>

      {/* BOTTOM NAVIGATION BAR (MOBILE ONLY) */}
      <div className="lg:hidden fixed bottom-0 left-0 w-full bg-white border-t border-slate-200 shadow-[0_-5px_10px_rgba(0,0,0,0.05)] z-40 flex justify-around items-center px-2 py-2 pb-safe">
        <button 
          onClick={() => { setActiveTab('study'); window.scrollTo({top: 0, behavior: 'smooth'}); }}
          className={`flex flex-col items-center justify-center p-2 rounded-xl flex-1 transition-all duration-300 ${activeTab === 'study' ? 'text-[#004488] bg-blue-50' : 'text-slate-400 hover:text-slate-600'}`}
        >
          <Home className={`w-6 h-6 mb-1 ${activeTab === 'study' ? 'fill-[#004488] text-[#004488]' : ''}`} />
          <span className="text-[10px] font-bold uppercase tracking-wide">H·ªçc t·∫≠p</span>
        </button>

        <button 
          onClick={() => { setActiveTab('stats'); window.scrollTo({top: 0, behavior: 'smooth'}); }}
          className={`flex flex-col items-center justify-center p-2 rounded-xl flex-1 transition-all duration-300 ${activeTab === 'stats' ? 'text-[#004488] bg-blue-50' : 'text-slate-400 hover:text-slate-600'}`}
        >
          <User className={`w-6 h-6 mb-1 ${activeTab === 'stats' ? 'fill-[#004488] text-[#004488]' : ''}`} />
          <span className="text-[10px] font-bold uppercase tracking-wide">Th√†nh t√≠ch</span>
        </button>

        <button 
          onClick={() => { setActiveTab('library'); window.scrollTo({top: 0, behavior: 'smooth'}); }}
          className={`flex flex-col items-center justify-center p-2 rounded-xl flex-1 transition-all duration-300 ${activeTab === 'library' ? 'text-[#004488] bg-blue-50' : 'text-slate-400 hover:text-slate-600'}`}
        >
          <Book className={`w-6 h-6 mb-1 ${activeTab === 'library' ? 'fill-[#004488] text-[#004488]' : ''}`} />
          <span className="text-[10px] font-bold uppercase tracking-wide">Kho t·ª´</span>
        </button>
      </div>

      {/* FLOATING ACTION BUTTONS */}
      <div className="fixed bottom-24 lg:bottom-6 right-6 flex flex-col space-y-3 z-30">
        <a href="https://facebook.com" className="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center shadow-lg hover:scale-110 transition shake-animation"><Share2 className="w-6 h-6 text-white" /></a>
        <a href="https://zalo.me" className="w-12 h-12 bg-blue-400 rounded-full flex items-center justify-center shadow-lg hover:scale-110 transition shake-animation" style={{animationDelay: '1s'}}><MessageCircle className="w-6 h-6 text-white" /></a>
      </div>
    </div>
  );
};

export default SATVocabularyTool;
